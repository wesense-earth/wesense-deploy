# WeSense Platform Configuration
# Copy this file to .env and customize as needed.
#
# Before starting, you MUST change the passwords marked CHANGEME below.
# The config-check service will refuse to start if default passwords are detected.
#
# The defaults use Docker service names (emqx, clickhouse) which work
# automatically inside the Docker network. Don't change these to IP
# addresses unless you know what you're doing.

# ===========================================
# Deployment Persona
# ===========================================
# Which services to run. Options:
#   station     - Full local stack (EMQX + ClickHouse + Ingesters + Respiro)
#   contributor - Ingesters only (sends to remote MQTT hub)
#   hub         - MQTT broker only (production mqtt.wesense.earth)
#
# Add-on profiles (combine with a base profile):
#   downlink    - Global Meshtastic downlink (hub operators only, heavy traffic)
#                 Example: COMPOSE_PROFILES=station,downlink
#
# Start with: docker compose --profile station up -d
COMPOSE_PROFILES=station

# ===========================================
# Data Directory
# ===========================================
# All persistent data is stored under this directory, organized by service:
#   data/clickhouse/data, data/clickhouse/logs
#   data/emqx/data, data/emqx/log
#   data/ingester-meshtastic/cache, data/ingester-meshtastic/logs
#   data/ingester-meshtastic-downlink/cache, data/ingester-meshtastic-downlink/logs
#   data/ingester-wesense/cache, data/ingester-wesense/logs
#   data/ingester-homeassistant/logs
#   data/deployment-classifier/reports, data/deployment-classifier/logs
#   data/respiro
#
# Default is './data' (relative to this directory).
# For production, use an absolute path (e.g., /mnt/pool/wesense/data)
DATA_DIR=./data

# ===========================================
# Timezone
# ===========================================
TZ=Pacific/Auckland

# ===========================================
# Container User ID
# ===========================================
# UID:GID that services run as inside containers.
# Default 1000:1000 matches the emqx image default.
# TrueNAS: set to 568:568 (apps:apps)
PUID=1000
PGID=1000

# ===========================================
# ClickHouse
# ===========================================
# The database for storing sensor readings.
# Both passwords are required for station/observer profiles.
# Change them from CHANGEME to real passwords before starting.
#
# CLICKHOUSE_ADMIN_PASSWORD: admin ('default') user — used internally by
#   the container for schema init. Not exposed to ingesters.
# CLICKHOUSE_USER / CLICKHOUSE_PASSWORD: restricted app user — created
#   automatically on first start by 00-create-app-user.sh. Used by ingesters
#   and Respiro. Has SELECT/INSERT only on wesense and wesense_respiro databases.
CLICKHOUSE_DB=wesense
CLICKHOUSE_ADMIN_PASSWORD=CHANGEME
CLICKHOUSE_USER=wesense
CLICKHOUSE_PASSWORD=CHANGEME

# ClickHouse data directory (sensor readings — can grow large)
# Defaults to DATA_DIR/clickhouse. Override to store on a separate drive.
# Example: CLICKHOUSE_DATA_DIR=/mnt/hdd_pool/clickhouse
#CLICKHOUSE_DATA_DIR=

# Leave as 'clickhouse' for station profile (Docker service name)
# Only change if connecting to an external ClickHouse server
CLICKHOUSE_HOST=clickhouse
CLICKHOUSE_PORT=8123

# Ingester batching settings
CLICKHOUSE_BATCH_SIZE=100
CLICKHOUSE_FLUSH_INTERVAL=10

# ===========================================
# MQTT Broker (EMQX)
# ===========================================
# Leave as 'emqx' for station profile (Docker service name)
# For contributor profile: set to your remote hub (e.g., mqtt.wesense.earth)
MQTT_HOST=emqx
MQTT_PORT=1883

# MQTT authentication (opt-in)
# Set both MQTT_USER and MQTT_PASSWORD to enable EMQX password authentication.
# Leave both empty for anonymous access (default — fine for local networks).
# The init-auth.sh entrypoint script configures EMQX automatically.
MQTT_USER=
MQTT_PASSWORD=

# EMQX dashboard password (required for hub/station profiles)
# The dashboard is at http://<host>:18083 — login as 'admin' with this password.
# Change from CHANGEME to a real password before starting.
EMQX_DASHBOARD_PASSWORD=CHANGEME

# ===========================================
# Host Port Mapping
# ===========================================
# Ports exposed from containers to your host machine.
# Services always communicate internally via Docker network.

# MQTT — for sensors and devices to connect from outside Docker
# If you already have an MQTT broker (e.g., Mosquitto for Home Assistant),
# change this to avoid a port conflict (e.g., 1884).
PORT_MQTT=1883

# Respiro map — typically put behind a reverse proxy for HTTPS
# Change if port 3000 is already in use (e.g., Grafana, Home Assistant add-ons).
PORT_RESPIRO=3000

# Uncomment to expose additional ports:
#PORT_DASHBOARD=18083        # EMQX admin UI
#PORT_CLICKHOUSE_HTTP=8123   # ClickHouse HTTP (for external tools)
#PORT_WS=8083                # WebSocket MQTT (browser clients)

# ===========================================
# TLS Configuration (optional)
# ===========================================
# For production, enable TLS on MQTT. Place certs in ./certs/
TLS_MQTT_ENABLED=false
TLS_WS_ENABLED=false
TLS_CERTFILE=/opt/emqx/etc/certs/fullchain.pem
TLS_KEYFILE=/opt/emqx/etc/certs/privkey.pem
PORT_MQTT_TLS=8883

# ===========================================
# WeSense Ingester
# ===========================================
# TTN webhook (optional HTTP receiver for The Things Network)
TTN_WEBHOOK_ENABLED=false

# ===========================================
# Home Assistant Ingester (optional)
# ===========================================
# Only needed if you want to pull data from Home Assistant.
# Create config/config.yaml from config/config.yaml.sample to enable.
HA_URL=http://homeassistant.local:8123
HA_ACCESS_TOKEN=
HA_NODE_NAME=
# Set to 'true' to skip ClickHouse writes (MQTT-only mode, useful for contributor profile)
DISABLE_CLICKHOUSE=false

# ===========================================
# Contributor Profile — Remote Hub Settings
# ===========================================
# If running as 'contributor' (ingesters only, no local EMQX/ClickHouse),
# uncomment and set these to point to your remote hub:
#MQTT_HOST=mqtt.wesense.earth
#MQTT_PORT=8883
#WESENSE_OUTPUT_BROKER=mqtt.wesense.earth
#WESENSE_OUTPUT_PORT=8883

# ===========================================
# Zenoh P2P Network (optional)
# ===========================================
# Enables Zenoh publish alongside MQTT. Requires zenohd service (station profile).
# Set to false to disable Zenoh entirely (MQTT + ClickHouse still work normally).
ZENOH_ENABLED=true
ZENOH_MODE=client
# For station: local zenohd. For contributor: community router(s).
ZENOH_ROUTERS=tcp/zenohd:7447
#ZENOH_ROUTERS=tcp/router1.wesense.earth:7447,tcp/router2.wesense.earth:7447
ZENOH_KEY_PREFIX=wesense/v2/live
PORT_ZENOH=7447

# Zenoh API — distributed query frontend (station + observer profiles)
# Query timeout for collecting responses from all queryables
ZENOH_QUERY_TIMEOUT=5.0
# Zenoh API URL for Respiro P2P proxy (auto-configured for Docker)
#ZENOH_API_URL=http://zenoh-api:5100

# ===========================================
# OrbitDB Registry (optional)
# ===========================================
# Enables automatic node registration and trust list synchronisation.
# When disabled, trust is managed via local trust_list.json files.
ORBITDB_ENABLED=false
ORBITDB_URL=http://wesense-orbitdb:5200
ORBITDB_SYNC_INTERVAL=3600

# libp2p bootstrap peers for cross-internet OrbitDB replication.
# Leave empty for LAN-only (mDNS) discovery.
# For multi-site: set to other station's multiaddr.
# Example: /ip4/203.0.113.1/tcp/4002/p2p/12D3Koo...
#ORBITDB_BOOTSTRAP_PEERS=

# Exposed ports
PORT_LIBP2P=4002

# ===========================================
# Observer Profile — Remote Zenoh Settings
# ===========================================
# If running as 'observer' (ClickHouse + Respiro, no local ingesters),
# set ZENOH_ROUTERS to the remote station's Zenoh router address.
# The zenoh-bridge will subscribe and write incoming readings to local ClickHouse.
#ZENOH_ROUTERS=tcp/station.example.com:7447
# Key expression to subscribe to (default: all WeSense live data)
#ZENOH_SUBSCRIBE_KEY=wesense/v2/live/**

# ===========================================
# Logging
# ===========================================
DEBUG=false
LOG_LEVEL=INFO

# ===========================================
# Map Settings (optional)
# ===========================================
# Override map centre (auto-detects from sensor data by default)
#MAP_CENTER_LAT=-36.848
#MAP_CENTER_LNG=174.763
#MAP_ZOOM_LEVEL=10

# ===========================================
# Container Images
# ===========================================
# Controls which version of all WeSense container images to pull.
# This single variable sets the tag for every service at once.
#
# Available tags:
#   latest  — Stable release (built from main branch)
#   dev     — Development builds (built from dev branch, may be unstable)
#   v1.2.3  — Pinned release version
#
# To test new features before they're merged to main:
#   IMAGE_TAG=dev
#
# To go back to stable:
#   IMAGE_TAG=latest
IMAGE_TAG=latest

# Override individual images if needed (takes precedence over IMAGE_TAG).
# Only uncomment these if you need a specific service on a different tag
# or want to point at a local build.
#INGESTER_MESHTASTIC_IMAGE=ghcr.io/wesense-earth/wesense-ingester-meshtastic:latest
#INGESTER_WESENSE_IMAGE=ghcr.io/wesense-earth/wesense-ingester-wesense:latest
#INGESTER_HA_IMAGE=ghcr.io/wesense-earth/wesense-ingester-homeassistant:latest
#RESPIRO_IMAGE=ghcr.io/wesense-earth/wesense-respiro:latest
#CLASSIFIER_IMAGE=ghcr.io/wesense-earth/wesense-deployment-classifier:latest
#ZENOH_BRIDGE_IMAGE=ghcr.io/wesense-earth/wesense-zenoh-bridge:latest
#ZENOH_API_IMAGE=ghcr.io/wesense-earth/wesense-zenoh-api:latest
#ORBITDB_IMAGE=ghcr.io/wesense-earth/wesense-orbitdb:latest
