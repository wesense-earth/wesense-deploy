# WeSense Platform - Docker Compose Configuration
# See Deployment_Personas.md for full details
#
# Personas (set COMPOSE_PROFILES in .env):
#   contributor - Ingesters only (sends to remote MQTT hub)
#   station     - Full local stack (EMQX + ClickHouse + Ingesters + Respiro)
#   hub         - MQTT broker only (production mqtt.wesense.earth)
#   downlink    - Meshtastic global downlink (add to station, hub operators only)
#   observer    - Map + ClickHouse (future, needs P2P)
#   researcher  - ClickHouse + IPFS (future)
#   guardian    - IPFS pinning (future)
#
# Quick start:
#   1. Copy .env.sample to .env
#   2. Edit .env with your values
#   3. Run: docker compose --profile station up -d
#   4. Access Respiro map at http://localhost:3000

services:
  # ===========================================================================
  # Config Validator — fails fast if passwords are still set to CHANGEME
  # All services depend on this so nothing starts with default passwords.
  # ===========================================================================
  config-check:
    image: busybox:latest
    container_name: wesense-config-check
    profiles: ["hub", "station", "contributor", "observer", "downlink"]
    environment:
      - CLICKHOUSE_ADMIN_PASSWORD=${CLICKHOUSE_ADMIN_PASSWORD:-}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:-}
      - EMQX_DASHBOARD_PASSWORD=${EMQX_DASHBOARD_PASSWORD:-}
      - MQTT_USER=${MQTT_USER:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - COMPOSE_PROFILES=${COMPOSE_PROFILES:-}
      - ZENOH_ENABLED=${ZENOH_ENABLED:-true}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        ok=true

        # ClickHouse passwords — required for station/observer profiles
        case "$$COMPOSE_PROFILES" in
          *station*|*observer*)
            if [ -z "$$CLICKHOUSE_ADMIN_PASSWORD" ] || [ "$$CLICKHOUSE_ADMIN_PASSWORD" = "CHANGEME" ]; then
              echo "ERROR: CLICKHOUSE_ADMIN_PASSWORD must be set to a real password in .env (not empty, not CHANGEME)"
              ok=false
            fi
            if [ -z "$$CLICKHOUSE_PASSWORD" ] || [ "$$CLICKHOUSE_PASSWORD" = "CHANGEME" ]; then
              echo "ERROR: CLICKHOUSE_PASSWORD must be set to a real password in .env (not empty, not CHANGEME)"
              ok=false
            fi
            ;;
        esac

        # EMQX dashboard password — required for hub/station profiles
        case "$$COMPOSE_PROFILES" in
          *hub*|*station*)
            if [ -z "$$EMQX_DASHBOARD_PASSWORD" ] || [ "$$EMQX_DASHBOARD_PASSWORD" = "CHANGEME" ]; then
              echo "ERROR: EMQX_DASHBOARD_PASSWORD must be set to a real password in .env (not empty, not CHANGEME)"
              ok=false
            fi
            ;;
        esac

        # MQTT credentials — optional, but warn if partially set
        if [ -n "$$MQTT_USER" ] && [ -z "$$MQTT_PASSWORD" ]; then
          echo "WARNING: MQTT_USER is set but MQTT_PASSWORD is empty — MQTT auth will not be enabled"
        fi
        if [ -z "$$MQTT_USER" ] && [ -z "$$MQTT_PASSWORD" ]; then
          echo "NOTE: MQTT_USER/MQTT_PASSWORD not set — EMQX will allow anonymous connections"
        fi

        # Zenoh — warn if enabled but no routers configured
        if [ "$$ZENOH_ENABLED" = "true" ] && [ -z "$$ZENOH_ROUTERS" ]; then
          echo "WARNING: ZENOH_ENABLED=true but ZENOH_ROUTERS is empty — Zenoh publishing will fail"
        fi

        if [ "$$ok" = "false" ]; then
          echo "Fix the above errors in .env and try again."
          exit 1
        fi
        echo "Config OK."
    networks: []
    restart: "no"

  # ===========================================================================
  # EMQX - MQTT Broker
  # Profiles: hub, station
  #
  # Ports exposed to host are configured in .env — see "Host Port Mapping".
  # To expose additional ports (dashboard, WebSocket, TLS), add them in a
  # docker-compose.override.yml or uncomment below.
  # ===========================================================================
  emqx:
    image: emqx/emqx:5.8.9
    container_name: wesense-emqx
    profiles: ["hub", "station"]
    user: "0:0"
    depends_on:
      config-check:
        condition: service_completed_successfully
    entrypoint: /opt/emqx/scripts/init-auth.sh
    command: ["/opt/emqx/bin/emqx", "foreground"]
    ports:
      # MQTT — sensors and devices connect here
      - "${PORT_MQTT:-1883}:1883"
      # Uncomment to expose additional ports to the host:
      # - "${PORT_MQTT_TLS:-8883}:8883"    # MQTTS (TLS-encrypted MQTT)
      # - "${PORT_WS:-8083}:8083"           # WebSocket (browser-based MQTT clients)
      # - "${PORT_WS_TLS:-8084}:8084"       # WSS (TLS-encrypted WebSocket)
      # - "${PORT_DASHBOARD:-18083}:18083"   # EMQX admin dashboard
    volumes:
      - ${DATA_DIR:-./data}/emqx/data:/opt/emqx/data
      - ${DATA_DIR:-./data}/emqx/log:/opt/emqx/log
      - ./certs:/opt/emqx/etc/certs:ro
      - ./emqx/etc/emqx.conf:/opt/emqx/etc/emqx.conf:ro
      - ./emqx/scripts/init-auth.sh:/opt/emqx/scripts/init-auth.sh:ro
    environment:
      # Run as this UID:GID (default 1000:1000 = emqx image default)
      # TrueNAS: set to 568:568 (apps:apps) in .env
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      # MQTT authentication (opt-in: set both to enable, leave empty for anonymous)
      - MQTT_USER=${MQTT_USER:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      # Dashboard password (overrides default admin/public)
      - EMQX_DASHBOARD__DEFAULT_PASSWORD=${EMQX_DASHBOARD_PASSWORD:-public}
      # TLS listeners (disabled by default, enable in .env with certificates)
      - EMQX_LISTENERS__SSL__DEFAULT__ENABLED=${TLS_MQTT_ENABLED:-false}
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__CERTFILE=${TLS_CERTFILE:-/opt/emqx/etc/certs/fullchain.pem}
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__KEYFILE=${TLS_KEYFILE:-/opt/emqx/etc/certs/privkey.pem}
      - EMQX_LISTENERS__WSS__DEFAULT__ENABLED=${TLS_WS_ENABLED:-false}
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__CERTFILE=${TLS_CERTFILE:-/opt/emqx/etc/certs/fullchain.pem}
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__KEYFILE=${TLS_KEYFILE:-/opt/emqx/etc/certs/privkey.pem}
      - TZ=${TZ:-Pacific/Auckland}
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # ClickHouse - Time Series Database
  # Profiles: station, observer
  # Creates both 'wesense' and 'wesense_respiro' databases on first start.
  # No ports exposed by default — services connect via Docker network.
  # To access ClickHouse from outside Docker (e.g., DBeaver, clickhouse-client),
  # uncomment the ports below or add them in docker-compose.override.yml.
  # ===========================================================================
  clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: wesense-clickhouse
    profiles: ["station", "observer"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    # ports:
    #   - "${PORT_CLICKHOUSE_HTTP:-8123}:8123"    # HTTP interface
    #   - "${PORT_CLICKHOUSE_NATIVE:-9000}:9000"  # Native TCP interface
    # Set CLICKHOUSE_DATA_DIR in .env to store sensor data on a separate drive (e.g., HDD)
    # Defaults to DATA_DIR/clickhouse alongside other services
    volumes:
      - ${CLICKHOUSE_DATA_DIR:-${DATA_DIR:-./data}/clickhouse}/data:/var/lib/clickhouse
      - ${CLICKHOUSE_DATA_DIR:-${DATA_DIR:-./data}/clickhouse}/logs:/var/log/clickhouse-server
      - ./clickhouse/init:/docker-entrypoint-initdb.d:ro
    environment:
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-wesense}
      # Admin user — used by Docker image for init scripts and management
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_ADMIN_PASSWORD:?Set CLICKHOUSE_ADMIN_PASSWORD in .env}
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      # App user — created by 00-create-app-user.sh on first start
      - CLICKHOUSE_APP_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_APP_PASSWORD=${CLICKHOUSE_PASSWORD}
      - TZ=${TZ:-Pacific/Auckland}
    cap_add:
      - SYS_NICE            # Suppresses "get_mempolicy: Operation not permitted" NUMA warnings
    ulimits:
      nproc: 65535
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # Zenoh Router — P2P data distribution
  # Profiles: station
  # Provides a local Zenoh router for ingesters to publish signed readings.
  # Contributors connect to a remote router instead.
  # ===========================================================================
  zenohd:
    image: eclipse/zenoh:1.7.2
    container_name: wesense-zenohd
    profiles: ["station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    ports:
      - "${PORT_ZENOH:-7447}:7447"
    volumes:
      - ./zenoh/zenohd.json5:/zenoh.json5:ro
    command: ["--config", "/zenoh.json5"]
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Meshtastic Ingester (Unified: public + community)
  # Profiles: contributor, station
  # Community mode (default): receives from a local Meshtastic node via EMQX
  # Public mode: subscribes to mqtt.meshtastic.org (hub operators only)
  # depends_on with required: false — waits for EMQX/ClickHouse in station
  # profile, skips gracefully in contributor profile (connects to remote hosts).
  # ===========================================================================
  ingester-meshtastic:
    image: ${INGESTER_MESHTASTIC_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-meshtastic:latest}
    container_name: wesense-ingester-meshtastic
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      emqx:
        condition: service_healthy
        required: false
      clickhouse:
        condition: service_healthy
        required: false
      zenohd:
        condition: service_started
        required: false
      wesense-orbitdb:
        condition: service_started
        required: false
    volumes:
      - ${DATA_DIR:-./data}/ingester-meshtastic/cache:/app/cache
      - ${DATA_DIR:-./data}/ingester-meshtastic/logs:/app/logs
      - ${DATA_DIR:-./data}/ingester-meshtastic/keys:/app/data/keys
    environment:
      # MQTT input (local EMQX where Meshtastic node pushes)
      - MQTT_BROKER=${MQTT_HOST:-emqx}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # MQTT output for publishing decoded messages
      - WESENSE_OUTPUT_BROKER=${MQTT_HOST:-emqx}
      - WESENSE_OUTPUT_PORT=${MQTT_PORT:-1883}
      - WESENSE_OUTPUT_USERNAME=${MQTT_USER}
      - WESENSE_OUTPUT_PASSWORD=${MQTT_PASSWORD}
      # Zenoh P2P (optional)
      - ZENOH_ENABLED=${ZENOH_ENABLED:-true}
      - ZENOH_MODE=${ZENOH_MODE:-client}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-tcp/zenohd:7447}
      - ZENOH_KEY_PREFIX=${ZENOH_KEY_PREFIX:-wesense/v2/live}
      - ZENOH_KEY_DIR=/app/data/keys
      # OrbitDB registry (optional — automated trust sync)
      - ORBITDB_ENABLED=${ORBITDB_ENABLED:-false}
      - ORBITDB_URL=${ORBITDB_URL:-http://wesense-orbitdb:5200}
      - ORBITDB_SYNC_INTERVAL=${ORBITDB_SYNC_INTERVAL:-3600}
      # Logging
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Meshtastic Downlink Ingester (Global)
  # Profile: downlink (opt-in, combine with station)
  # Subscribes to mqtt.meshtastic.org and community servers worldwide.
  # Generates significant MQTT traffic — only run this if you are a hub operator
  # or intentionally collecting global Meshtastic environmental data.
  #
  # Enable with:  docker compose --profile station --profile downlink up -d
  # Or in .env:   COMPOSE_PROFILES=station,downlink
  #
  # Edit ingester-meshtastic-downlink/config/mqtt_regions.json to enable/disable
  # specific regions.
  # ===========================================================================
  ingester-meshtastic-downlink:
    image: ${INGESTER_MESHTASTIC_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-meshtastic:latest}
    container_name: wesense-meshtastic-downlink
    profiles: ["downlink"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      emqx:
        condition: service_healthy
        required: false
      clickhouse:
        condition: service_healthy
        required: false
      zenohd:
        condition: service_started
        required: false
    volumes:
      - ${DATA_DIR:-./data}/ingester-meshtastic-downlink/cache:/app/cache
      - ${DATA_DIR:-./data}/ingester-meshtastic-downlink/logs:/app/logs
      - ./ingester-meshtastic-downlink/config:/app/config:ro
      - ${DATA_DIR:-./data}/ingester-meshtastic-downlink/keys:/app/data/keys
    environment:
      - MESHTASTIC_MODE=downlink
      # ClickHouse connection
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # MQTT output for publishing decoded messages
      - WESENSE_OUTPUT_BROKER=${MQTT_HOST:-emqx}
      - WESENSE_OUTPUT_PORT=${MQTT_PORT:-1883}
      - WESENSE_OUTPUT_USERNAME=${MQTT_USER}
      - WESENSE_OUTPUT_PASSWORD=${MQTT_PASSWORD}
      # Zenoh P2P (optional)
      - ZENOH_ENABLED=${ZENOH_ENABLED:-true}
      - ZENOH_MODE=${ZENOH_MODE:-client}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-tcp/zenohd:7447}
      - ZENOH_KEY_PREFIX=${ZENOH_KEY_PREFIX:-wesense/v2/live}
      - ZENOH_KEY_DIR=/app/data/keys
      # Logging
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # WeSense Ingester (Unified: WiFi + LoRa + TTN webhook)
  # Profiles: contributor, station
  # Subscribes to wesense/v2/wifi/# and wesense/v2/lora/# topics
  # Optionally runs TTN webhook HTTP server (TTN_WEBHOOK_ENABLED=true)
  # ===========================================================================
  ingester-wesense:
    image: ${INGESTER_WESENSE_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-wesense:latest}
    container_name: wesense-ingester-wesense
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      emqx:
        condition: service_healthy
        required: false
      clickhouse:
        condition: service_healthy
        required: false
      zenohd:
        condition: service_started
        required: false
      wesense-orbitdb:
        condition: service_started
        required: false
    volumes:
      - ${DATA_DIR:-./data}/ingester-wesense/cache:/app/cache
      - ${DATA_DIR:-./data}/ingester-wesense/logs:/app/logs
      - ${DATA_DIR:-./data}/ingester-wesense/keys:/app/data/keys
    environment:
      # MQTT input (subscribe to sensor topics)
      - MQTT_BROKER=${MQTT_HOST:-emqx}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # MQTT output for decoded messages
      - WESENSE_OUTPUT_BROKER=${MQTT_HOST:-emqx}
      - WESENSE_OUTPUT_PORT=${MQTT_PORT:-1883}
      - WESENSE_OUTPUT_USERNAME=${MQTT_USER}
      - WESENSE_OUTPUT_PASSWORD=${MQTT_PASSWORD}
      # Zenoh P2P (optional)
      - ZENOH_ENABLED=${ZENOH_ENABLED:-true}
      - ZENOH_MODE=${ZENOH_MODE:-client}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-tcp/zenohd:7447}
      - ZENOH_KEY_PREFIX=${ZENOH_KEY_PREFIX:-wesense/v2/live}
      - ZENOH_KEY_DIR=/app/data/keys
      # OrbitDB registry (optional — automated trust sync)
      - ORBITDB_ENABLED=${ORBITDB_ENABLED:-false}
      - ORBITDB_URL=${ORBITDB_URL:-http://wesense-orbitdb:5200}
      - ORBITDB_SYNC_INTERVAL=${ORBITDB_SYNC_INTERVAL:-3600}
      # TTN webhook (optional)
      - TTN_WEBHOOK_ENABLED=${TTN_WEBHOOK_ENABLED:-false}
      - TTN_WEBHOOK_PORT=${TTN_WEBHOOK_PORT:-5000}
      # Logging
      - DEBUG=${DEBUG:-false}
      - TZ=${TZ:-Pacific/Auckland}
    # TTN webhook port — uncomment if receiving The Things Network uplinks
    # directly (not needed if using cloudflared tunnel or similar)
    # ports:
    #   - "${PORT_TTN_WEBHOOK:-5000}:5000"
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Home Assistant Ingester
  # Profiles: contributor, station
  # Pulls sensor data from Home Assistant (WebSocket/REST)
  # Critical: loop prevention filters exclude WeSense ESP32 devices
  #
  # Requires config/config.yaml — see ingester-homeassistant/config/config.yaml.sample
  # Will exit cleanly if config is missing (restart: on-failure prevents crash loops).
  # ===========================================================================
  ingester-homeassistant:
    image: ${INGESTER_HA_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-homeassistant:latest}
    container_name: wesense-ingester-homeassistant
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      emqx:
        condition: service_healthy
        required: false
      clickhouse:
        condition: service_healthy
        required: false
    volumes:
      - ./ingester-homeassistant/config:/app/config:ro
      - ${DATA_DIR:-./data}/ingester-homeassistant/logs:/app/logs
    environment:
      # Home Assistant connection
      - HA_URL=${HA_URL:-http://homeassistant.local:8123}
      - HA_ACCESS_TOKEN=${HA_ACCESS_TOKEN}
      - NODE_NAME=${HA_NODE_NAME:-}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      # MQTT output for decoded messages
      - LOCAL_MQTT_BROKER=${MQTT_HOST:-emqx}
      - LOCAL_MQTT_PORT=${MQTT_PORT:-1883}
      # Options
      - DISABLE_CLICKHOUSE=${DISABLE_CLICKHOUSE:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: on-failure
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Respiro - Environmental Sensor Map
  # Profiles: station, observer
  # Web dashboard displaying sensor data from ClickHouse.
  # Typically served behind a reverse proxy (SWAG, Caddy, Nginx Proxy Manager)
  # which handles TLS/letsencrypt — Respiro itself serves plain HTTP.
  # ===========================================================================
  respiro:
    image: ${RESPIRO_IMAGE:-ghcr.io/wesense-earth/wesense-respiro:latest}
    container_name: wesense-respiro
    profiles: ["station", "observer"]
    ports:
      - "${PORT_RESPIRO:-3000}:3000"
    volumes:
      - ${DATA_DIR:-./data}/respiro:/app/data
    environment:
      # ClickHouse connection
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USERNAME=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      # MQTT for real-time updates (optional)
      - MQTT_BROKER_URL=mqtt://${MQTT_HOST:-emqx}:${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_TOPIC_FILTER=wesense/decoded/#
      # Server
      - PORT=3000
      - HOST=0.0.0.0
      # Zenoh P2P API (optional — enables /api/p2p/* endpoints)
      - ZENOH_API_URL=${ZENOH_API_URL:-http://zenoh-api:5100}
      # Map centre — auto-detects from sensor data by default.
      # Uncomment to override (values from .env if set).
      # - MAP_CENTER_LAT=${MAP_CENTER_LAT:--36.848}
      # - MAP_CENTER_LNG=${MAP_CENTER_LNG:-174.763}
      # - MAP_ZOOM_LEVEL=${MAP_ZOOM_LEVEL:-10}
      - TZ=${TZ:-Pacific/Auckland}
    depends_on:
      config-check:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
      zenoh-api:
        condition: service_started
        required: false
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # Deployment Classifier
  # Profiles: station
  # Analyses sensor behaviour (variance, weather correlation, temp range) to
  # classify devices as indoor/outdoor/device/mobile etc. Runs on a cron
  # schedule (default: every 12 hours). Uses Open-Meteo API for weather data.
  # ===========================================================================
  deployment-classifier:
    image: ${CLASSIFIER_IMAGE:-ghcr.io/wesense-earth/wesense-deployment-classifier:latest}
    container_name: wesense-deployment-classifier
    profiles: ["station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
    volumes:
      - ${DATA_DIR:-./data}/deployment-classifier/reports:/app/reports
      - ${DATA_DIR:-./data}/deployment-classifier/logs:/app/logs
    environment:
      # ClickHouse connection (includes protocol)
      - CLICKHOUSE_HOST=http://${CLICKHOUSE_HOST:-clickhouse}:${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      # Classifier settings
      - CLASSIFIER_MODE=scheduler
      - CLASSIFIER_SCHEDULE=${CLASSIFIER_SCHEDULE:-0 */12 * * *}
      - RUN_ON_STARTUP=${CLASSIFIER_RUN_ON_STARTUP:-true}
      - DRY_RUN=${CLASSIFIER_DRY_RUN:-false}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # OrbitDB — Distributed Node Registry & Trust Sync
  # Profiles: station, observer
  # Helia (IPFS) + OrbitDB for automated peer discovery and trust list
  # replication. Port 4002 exposed for libp2p peer connections between stations.
  # HTTP API (5200) is internal to Docker network only.
  # ===========================================================================
  wesense-orbitdb:
    image: ${ORBITDB_IMAGE:-ghcr.io/wesense-earth/wesense-orbitdb:latest}
    container_name: wesense-orbitdb
    profiles: ["station", "observer"]
    volumes:
      - ${DATA_DIR:-./data}/orbitdb:/app/data
    ports:
      - "${PORT_LIBP2P:-4002}:4002"
    environment:
      - PORT=5200
      - DATA_DIR=/app/data
      - ORBITDB_BOOTSTRAP_PEERS=${ORBITDB_BOOTSTRAP_PEERS:-}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Zenoh Bridge — P2P Data Receiver
  # Profiles: station, observer
  # Subscribes to Zenoh, verifies signatures against a trust list, and writes
  # incoming readings to the local ClickHouse. On station profile this enables
  # receiving data from other stations; on observer it's the sole data source.
  # ===========================================================================
  zenoh-bridge:
    image: ${ZENOH_BRIDGE_IMAGE:-ghcr.io/wesense-earth/wesense-zenoh-bridge:latest}
    container_name: wesense-zenoh-bridge
    profiles: ["station", "observer"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      clickhouse:
        condition: service_healthy
      zenohd:
        condition: service_started
        required: false
      wesense-orbitdb:
        condition: service_started
        required: false
    volumes:
      - ${DATA_DIR:-./data}/zenoh-bridge/data:/app/data
      - ${DATA_DIR:-./data}/zenoh-bridge/logs:/app/logs
      # Local ingester keys (read-only) — used for self-echo filtering
      - ${DATA_DIR:-./data}/ingester-wesense/keys:/app/local-keys/wesense:ro
      - ${DATA_DIR:-./data}/ingester-meshtastic/keys:/app/local-keys/meshtastic:ro
      - ${DATA_DIR:-./data}/ingester-meshtastic-downlink/keys:/app/local-keys/meshtastic-downlink:ro
    environment:
      # Zenoh connection (client mode — station: local zenohd, observer: remote router)
      - ZENOH_ENABLED=true
      - ZENOH_MODE=${ZENOH_MODE:-client}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-tcp/zenohd:7447}
      - ZENOH_SUBSCRIBE_KEY=${ZENOH_SUBSCRIBE_KEY:-wesense/v2/live/**}
      # ClickHouse connection (local database)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-wesense}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # Trust store
      - TRUST_FILE=/app/data/trust_list.json
      # OrbitDB registry (optional — automated trust sync, observer mode)
      - ORBITDB_ENABLED=${ORBITDB_ENABLED:-false}
      - ORBITDB_URL=${ORBITDB_URL:-http://wesense-orbitdb:5200}
      - ORBITDB_SYNC_INTERVAL=${ORBITDB_SYNC_INTERVAL:-3600}
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Zenoh API — HTTP Frontend for Distributed Queries
  # Profiles: station, observer
  # Translates REST requests into Zenoh distributed queries.
  # Respiro calls these endpoints to show P2P data.
  # ===========================================================================
  zenoh-api:
    image: ${ZENOH_API_IMAGE:-ghcr.io/wesense-earth/wesense-zenoh-api:latest}
    container_name: wesense-zenoh-api
    profiles: ["station", "observer"]
    depends_on:
      config-check:
        condition: service_completed_successfully
      zenohd:
        condition: service_started
        required: false
    environment:
      # Zenoh connection
      - ZENOH_ENABLED=true
      - ZENOH_MODE=${ZENOH_MODE:-client}
      - ZENOH_ROUTERS=${ZENOH_ROUTERS:-tcp/zenohd:7447}
      # Query settings
      - ZENOH_QUERY_TIMEOUT=${ZENOH_QUERY_TIMEOUT:-5.0}
      - ZENOH_QUERY_KEY=${ZENOH_QUERY_KEY:-wesense/v2/live/**}
      - FLASK_PORT=5100
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # IPFS - Distributed Storage (future: guardian, researcher profiles)
  # ===========================================================================
  # ipfs:
  #   image: ipfs/kubo:v0.32
  #   container_name: wesense-ipfs
  #   profiles: ["guardian", "researcher"]
  #   ports:
  #     - "${PORT_IPFS_SWARM:-4001}:4001"       # Swarm
  #     - "${PORT_IPFS_API:-5001}:5001"         # API
  #     - "${PORT_IPFS_GATEWAY:-8080}:8080"     # Gateway
  #   volumes:
  #     - ipfs-data:/data/ipfs
  #   environment:
  #     - TZ=${TZ:-Pacific/Auckland}
  #   restart: unless-stopped
  #   networks:
  #     - wesense-net

# =============================================================================
# Networks
# =============================================================================
networks:
  wesense-net:
    driver: bridge
  # For connecting to external networks (e.g., SWAG reverse proxy)
  # Uncomment if you have a proxy-net network (e.g., from SWAG/Nginx Proxy Manager)
  # proxy-net:
  #   external: true
