# WeSense Platform - Docker Compose Configuration
# See Deployment_Personas.md for full details
#
# Personas (set COMPOSE_PROFILES in .env):
#   contributor - Ingesters only (sends to remote MQTT hub)
#   station     - Full local stack (EMQX + ClickHouse + Ingesters + Respiro)
#   hub         - MQTT broker only (production mqtt.wesense.earth)
#   observer    - Map + ClickHouse (future, needs P2P)
#   researcher  - ClickHouse + IPFS (future)
#   guardian    - IPFS pinning (future)
#
# Quick start:
#   1. Copy .env.sample to .env
#   2. Edit .env with your values
#   3. Run: docker compose --profile station up -d
#   4. Access Respiro map at http://localhost:3000
#
# Building locally (instead of pulling images):
#   docker compose --profile station build
#   docker compose --profile station up -d

services:
  # ===========================================================================
  # Config Validator — fails fast if passwords are still set to CHANGEME
  # All services depend on this so nothing starts with default passwords.
  # ===========================================================================
  config-check:
    image: busybox:latest
    container_name: wesense-config-check
    profiles: ["hub", "station", "contributor", "observer"]
    entrypoint: /bin/sh
    command:
      - -c
      - |
        fail=0
        for var in CLICKHOUSE_PASSWORD; do
          eval val=\$$var
          if [ "$$val" = "CHANGEME" ] || [ -z "$$val" ]; then
            echo "ERROR: $$var is not set — change it in .env" >&2
            fail=1
          fi
        done
        if [ "$$fail" = "1" ]; then
          echo "" >&2
          echo "Set real passwords in .env before starting." >&2
          exit 1
        fi
        echo "Config OK — all passwords set."
    environment:
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    networks: []
    restart: "no"

  # ===========================================================================
  # EMQX - MQTT Broker
  # Profiles: hub, station
  #
  # Ports exposed to host are configured in .env — see "Host Port Mapping".
  # To expose additional ports (dashboard, WebSocket, TLS), add them in a
  # docker-compose.override.yml or uncomment below.
  # ===========================================================================
  emqx:
    image: emqx/emqx:5.8.9
    container_name: wesense-emqx
    profiles: ["hub", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    ports:
      # MQTT — sensors and devices connect here
      - "${PORT_MQTT:-1883}:1883"
      # Uncomment to expose additional ports to the host:
      # - "${PORT_MQTT_TLS:-8883}:8883"    # MQTTS (TLS-encrypted MQTT)
      # - "${PORT_WS:-8083}:8083"           # WebSocket (browser-based MQTT clients)
      # - "${PORT_WS_TLS:-8084}:8084"       # WSS (TLS-encrypted WebSocket)
      # - "${PORT_DASHBOARD:-18083}:18083"   # EMQX admin dashboard
    volumes:
      - emqx-data:/opt/emqx/data
      - emqx-log:/opt/emqx/log
      - ./certs:/opt/emqx/etc/certs:ro
      - ./emqx/etc/emqx.conf:/opt/emqx/etc/emqx.conf:ro
    environment:
      # TLS listeners (disabled by default, enable in .env with certificates)
      - EMQX_LISTENERS__SSL__DEFAULT__ENABLED=${TLS_MQTT_ENABLED:-false}
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__CERTFILE=${TLS_CERTFILE:-/opt/emqx/etc/certs/fullchain.pem}
      - EMQX_LISTENERS__SSL__DEFAULT__SSL_OPTIONS__KEYFILE=${TLS_KEYFILE:-/opt/emqx/etc/certs/privkey.pem}
      - EMQX_LISTENERS__WSS__DEFAULT__ENABLED=${TLS_WS_ENABLED:-false}
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__CERTFILE=${TLS_CERTFILE:-/opt/emqx/etc/certs/fullchain.pem}
      - EMQX_LISTENERS__WSS__DEFAULT__SSL_OPTIONS__KEYFILE=${TLS_KEYFILE:-/opt/emqx/etc/certs/privkey.pem}
      - TZ=${TZ:-Pacific/Auckland}
    healthcheck:
      test: ["CMD", "emqx", "ctl", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # ClickHouse - Time Series Database
  # Profiles: station, observer
  # Creates both 'wesense' and 'wesense_respiro' databases on first start.
  # No ports exposed by default — services connect via Docker network.
  # To access ClickHouse from outside Docker (e.g., DBeaver, clickhouse-client),
  # uncomment the ports below or add them in docker-compose.override.yml.
  # ===========================================================================
  clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: wesense-clickhouse
    profiles: ["station", "observer"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    # ports:
    #   - "${PORT_CLICKHOUSE_HTTP:-8123}:8123"    # HTTP interface
    #   - "${PORT_CLICKHOUSE_NATIVE:-9000}:9000"  # Native TCP interface
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - ./clickhouse/init:/docker-entrypoint-initdb.d:ro
    environment:
      - CLICKHOUSE_DB=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD:?Set CLICKHOUSE_PASSWORD in .env}
      - TZ=${TZ:-Pacific/Auckland}
    cap_add:
      - SYS_NICE            # Suppresses "get_mempolicy: Operation not permitted" NUMA warnings
    ulimits:
      nproc: 65535
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # Meshtastic Ingester (Unified: public + community)
  # Profiles: contributor, station
  # Community mode (default): receives from a local Meshtastic node via EMQX
  # Public mode: subscribes to mqtt.meshtastic.org (hub operators only)
  # Note: No depends_on for EMQX/ClickHouse — the contributor profile runs
  # ingesters without local EMQX or ClickHouse (they connect to remote hosts).
  # Ingesters retry connections automatically, so startup order doesn't matter.
  # ===========================================================================
  ingester-meshtastic:
    image: ${INGESTER_MESHTASTIC_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-meshtastic:latest}
    build:
      context: ..
      dockerfile: wesense-ingester-meshtastic/Dockerfile
    container_name: wesense-ingester-meshtastic
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    volumes:
      - ./ingester-meshtastic/cache:/app/cache
      - ./ingester-meshtastic/config:/app/config:ro
      - ./ingester-meshtastic/logs:/app/logs
    environment:
      # Mode: 'community' (local node, default) or 'public' (mqtt.meshtastic.org, hub operators only)
      - MESHTASTIC_MODE=${MESHTASTIC_MODE:-community}
      # MQTT input (community mode: local EMQX where Meshtastic node pushes)
      - MQTT_BROKER=${MQTT_HOST:-emqx}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # MQTT output for publishing decoded messages
      - WESENSE_OUTPUT_BROKER=${MQTT_HOST:-emqx}
      - WESENSE_OUTPUT_PORT=${MQTT_PORT:-1883}
      - WESENSE_OUTPUT_USERNAME=${MQTT_USER}
      - WESENSE_OUTPUT_PASSWORD=${MQTT_PASSWORD}
      # Logging
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # WeSense Ingester (Unified: WiFi + LoRa + TTN webhook)
  # Profiles: contributor, station
  # Subscribes to wesense/v2/wifi/# and wesense/v2/lora/# topics
  # Optionally runs TTN webhook HTTP server (TTN_WEBHOOK_ENABLED=true)
  # ===========================================================================
  ingester-wesense:
    image: ${INGESTER_WESENSE_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-wesense:latest}
    build:
      context: ..
      dockerfile: wesense-ingester-wesense/Dockerfile
    container_name: wesense-ingester-wesense
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    volumes:
      - ingester-wesense-cache:/app/cache
      - ingester-wesense-logs:/app/logs
    environment:
      # MQTT input (subscribe to sensor topics)
      - MQTT_BROKER=${MQTT_HOST:-emqx}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_BATCH_SIZE=${CLICKHOUSE_BATCH_SIZE:-100}
      - CLICKHOUSE_FLUSH_INTERVAL=${CLICKHOUSE_FLUSH_INTERVAL:-10}
      # MQTT output for decoded messages
      - WESENSE_OUTPUT_BROKER=${MQTT_HOST:-emqx}
      - WESENSE_OUTPUT_PORT=${MQTT_PORT:-1883}
      - WESENSE_OUTPUT_USERNAME=${MQTT_USER}
      - WESENSE_OUTPUT_PASSWORD=${MQTT_PASSWORD}
      # TTN webhook (optional)
      - TTN_WEBHOOK_ENABLED=${TTN_WEBHOOK_ENABLED:-false}
      - TTN_WEBHOOK_PORT=${TTN_WEBHOOK_PORT:-5000}
      # Logging
      - DEBUG=${DEBUG:-false}
      - TZ=${TZ:-Pacific/Auckland}
    # TTN webhook port — uncomment if receiving The Things Network uplinks
    # directly (not needed if using cloudflared tunnel or similar)
    # ports:
    #   - "${PORT_TTN_WEBHOOK:-5000}:5000"
    restart: unless-stopped
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Home Assistant Ingester
  # Profiles: contributor, station
  # Pulls sensor data from Home Assistant (WebSocket/REST)
  # Critical: loop prevention filters exclude WeSense ESP32 devices
  #
  # Requires config/config.yaml — see ingester-homeassistant/config/config.yaml.sample
  # Will exit cleanly if config is missing (restart: on-failure prevents crash loops).
  # ===========================================================================
  ingester-homeassistant:
    image: ${INGESTER_HA_IMAGE:-ghcr.io/wesense-earth/wesense-ingester-homeassistant:latest}
    build:
      context: ..
      dockerfile: wesense-ingester-homeassistant/Dockerfile
    container_name: wesense-ingester-homeassistant
    profiles: ["contributor", "station"]
    depends_on:
      config-check:
        condition: service_completed_successfully
    volumes:
      - ./ingester-homeassistant/config:/app/config:ro
      - ingester-ha-logs:/app/logs
    environment:
      # Home Assistant connection
      - HA_URL=${HA_URL:-http://homeassistant.local:8123}
      - HA_ACCESS_TOKEN=${HA_ACCESS_TOKEN}
      - NODE_NAME=${HA_NODE_NAME:-}
      # ClickHouse connection (optional, gracefully handles unavailable)
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USER=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      # MQTT output for decoded messages
      - LOCAL_MQTT_BROKER=${MQTT_HOST:-emqx}
      - LOCAL_MQTT_PORT=${MQTT_PORT:-1883}
      # Options
      - DISABLE_CLICKHOUSE=${DISABLE_CLICKHOUSE:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TZ:-Pacific/Auckland}
    restart: on-failure
    networks:
      - wesense-net
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ===========================================================================
  # Respiro - Environmental Sensor Map
  # Profiles: station, observer
  # Web dashboard displaying sensor data from ClickHouse.
  # Typically served behind a reverse proxy (SWAG, Caddy, Nginx Proxy Manager)
  # which handles TLS/letsencrypt — Respiro itself serves plain HTTP.
  # ===========================================================================
  respiro:
    image: ${RESPIRO_IMAGE:-ghcr.io/wesense-earth/wesense-respiro:latest}
    container_name: wesense-respiro
    profiles: ["station", "observer"]
    ports:
      - "${PORT_RESPIRO:-3000}:3000"
    volumes:
      - ./respiro/data:/app/data
    environment:
      # ClickHouse connection
      - CLICKHOUSE_HOST=${CLICKHOUSE_HOST:-clickhouse}
      - CLICKHOUSE_PORT=${CLICKHOUSE_PORT:-8123}
      - CLICKHOUSE_DATABASE=${CLICKHOUSE_DB:-wesense}
      - CLICKHOUSE_USERNAME=${CLICKHOUSE_USER:-default}
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      # MQTT for real-time updates (optional)
      - MQTT_BROKER_URL=mqtt://${MQTT_HOST:-emqx}:${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - MQTT_TOPIC_FILTER=wesense/decoded/#
      # Server
      - PORT=3000
      - HOST=0.0.0.0
      # Map centre — auto-detects from sensor data by default.
      # Uncomment to override (values from .env if set).
      # - MAP_CENTER_LAT=${MAP_CENTER_LAT:--36.848}
      # - MAP_CENTER_LNG=${MAP_CENTER_LNG:-174.763}
      # - MAP_ZOOM_LEVEL=${MAP_ZOOM_LEVEL:-10}
      - TZ=${TZ:-Pacific/Auckland}
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - wesense-net

  # ===========================================================================
  # IPFS - Distributed Storage (future: guardian, researcher profiles)
  # ===========================================================================
  # ipfs:
  #   image: ipfs/kubo:v0.32
  #   container_name: wesense-ipfs
  #   profiles: ["guardian", "researcher"]
  #   ports:
  #     - "${PORT_IPFS_SWARM:-4001}:4001"       # Swarm
  #     - "${PORT_IPFS_API:-5001}:5001"         # API
  #     - "${PORT_IPFS_GATEWAY:-8080}:8080"     # Gateway
  #   volumes:
  #     - ipfs-data:/data/ipfs
  #   environment:
  #     - TZ=${TZ:-Pacific/Auckland}
  #   restart: unless-stopped
  #   networks:
  #     - wesense-net

# =============================================================================
# Volumes
# =============================================================================
volumes:
  emqx-data:
  emqx-log:
  clickhouse-data:
  clickhouse-logs:
  ingester-wesense-cache:
  ingester-wesense-logs:
  ingester-ha-logs:
  # ipfs-data:

# =============================================================================
# Networks
# =============================================================================
networks:
  wesense-net:
    driver: bridge
  # For connecting to external networks (e.g., SWAG reverse proxy)
  # Uncomment if you have a proxy-net network (e.g., from SWAG/Nginx Proxy Manager)
  # proxy-net:
  #   external: true
